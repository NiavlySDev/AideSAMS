<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service - Aide SAMS</title>
    <link rel="stylesheet" href="style.css">
    <script src="update-notifier.js"></script>
</head>

<body>

    
    <div class="header"
        style="display:flex;align-items:center;justify-content:center;gap:18px;margin-top:18px;margin-bottom:18px;">
        <h1 style="margin:0;text-align:center;">Aide SAMS</h1>
        <div style="display:flex;align-items:center;gap:12px;margin-left:18px;">
            <span
                style="background:#22c55e;color:#181818;padding:6px 16px;border-radius:8px;font-weight:bold;font-size:1.05em;">
                v...
            </span>
            <button class="btn" onclick="location.href='informations.html'"
                style="background:#181818;color:#22c55e;border:1px solid #22c55e;">
                ‚ÑπÔ∏è Informations
            </button>
        </div>
    </div>
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="location.href='service.html'">Service</button>
        <button class="nav-tab" onclick="location.href='rapport.html'">Rapport de soins</button>
        <button class="nav-tab" onclick="location.href='refus_de_soin.html'">Refus de soins</button>
        <button class="nav-tab" onclick="location.href='morgue.html'">Morgue</button>
        <button class="nav-tab" onclick="location.href='impayes.html'">Impay√©s</button>
        <button class="nav-tab" onclick="location.href='lspd.html'">LSPD</button>
        <button class="nav-tab" id="ph-tab" onclick="location.href='ph.html'">PH</button>
        <button class="nav-tab" id="prof-tab" onclick="location.href='professeur.html'">Professeur</button>
        <button class="nav-tab" onclick="location.href='manuels.html'">Manuels</button>
        <button class="nav-tab" onclick="location.href='suggestions.html'">Suggestions/Bugs</button>
        <button class="nav-tab" onclick="location.href='hierarchie.html'">Hi√©rarchie</button>
        <button class="nav-tab" onclick="location.href='parametres.html'">Param√®tres</button>
    </nav>

    <div class="sub-nav" style="display: flex; align-items: center;">
        <div id="service-tabs" style="flex:1; display:flex;"></div>
        <button class="btn" id="add-service-btn" onclick="addService()" style="margin-left:16px; white-space:nowrap;">‚ûï
            Ajouter un service</button>
    </div>
    <div class="main-container" style="display:block;max-width:900px;">
        <div class="card template-box" style="position:relative;">
            <button class="copy-btn" onclick="copyTemplate()" style="top:16px;right:16px;">
                üìã <span>Copier</span>
            </button>
            <div id="template-content"></div>
        </div>
        <div id="cards-container"></div>
    </div>

    <script>
        const defaultService = () => ({
            samsName: "",
            date: "",
            pdsHour: "",
            pdsMinute: "",
            fdsHour: "",
            fdsMinute: "",
            actions: [
                { label: "Blessures l√©g√®res", count: 0 },
                { label: "Blessures moyennes", count: 0 },
                { label: "Blessures graves", count: 0 },
                { label: "10-17", count: 0 },
                { label: "10-18", count: 0 },
                { label: "10-19", count: 0 }
            ],
            recap: "",
            collapsed: [false, false, false],
        });

        let services = [];
        let currentService = 0;

        function saveServices() {
            localStorage.setItem('sams_services', JSON.stringify({ services, currentService }));
        }
        function loadServices() {
            const data = localStorage.getItem('sams_services');
            if (data) {
                const obj = JSON.parse(data);
                services = obj.services;
                currentService = obj.currentService;

                const baseActions = [
                    { label: "Blessures l√©g√®res", count: 0 },
                    { label: "Blessures moyennes", count: 0 },
                    { label: "Blessures graves", count: 0 },
                    { label: "10-17", count: 0 },
                    { label: "10-18", count: 0 },
                    { label: "10-19", count: 0 }
                ];
                services.forEach(s => {
                    if (!s.actions || !Array.isArray(s.actions)) s.actions = [];
                    baseActions.forEach(base => {
                        if (!s.actions.some(a => a.label === base.label)) {
                            s.actions.push({ label: base.label, count: base.count });
                        }
                    });
                });
            } else {
                services = [defaultService()];
                currentService = 0;
            }
        }

        function renderTabs() {
            const tabs = document.getElementById('service-tabs');
            tabs.innerHTML = "";
            services.forEach((s, i) => {
                let label = "Service n¬∞" + (i + 1);
                if (s.samsName.trim()) label = "Service [" + s.samsName.trim() + "]";
                tabs.innerHTML += `
                <button class="sub-nav-item${i === currentService ? ' active' : ''}" onclick="switchService(${i})">
                    ${label}
                    ${services.length > 1 ? '<button class="delete-rapport" onclick="deleteService(event,' + i + ')">‚úñ</button>' : ''}
                </button>
            `;
            });
        }

        function renderCards() {
            const s = services[currentService];
            const cards = [
                {
                    title: "üïí Horaires du service",
                    content: `
                    <div class="form-group">
                        <label>Date du service</label>
                        <input type="date" id="serviceDate" value="${s.date || ''}" oninput="updateField('date',this.value)">
                    </div>
                    <div class="form-group">
                        <label>Heure de Prise de Service (PDS)</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="number" min="0" max="23" placeholder="HH" style="width:65px" value="${s.pdsHour || ''}" oninput="updateField('pdsHour',this.value)">
                            <span>:</span>
                            <input type="number" min="0" max="59" placeholder="MM" style="width:65px" value="${s.pdsMinute || ''}" oninput="updateField('pdsMinute',this.value)">
                            <button type="button" class="btn" style="padding:2px 8px;font-size:13px;" onclick="setNow('pds')">Maintenant</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Heure de Fin de Service (FDS)</label>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="number" min="0" max="23" placeholder="HH" style="width:65px" value="${s.fdsHour || ''}" oninput="updateField('fdsHour',this.value)">
                            <span>:</span>
                            <input type="number" min="0" max="59" placeholder="MM" style="width:65px" value="${s.fdsMinute || ''}" oninput="updateField('fdsMinute',this.value)">
                            <button type="button" class="btn" style="padding:2px 8px;font-size:13px;" onclick="setNow('fds')">Maintenant</button>
                        </div>
                    </div>
                `
                },
                {
                    title: "üìù Actions et R√©capitulatif",
                    content: `
                    <div class="form-group">
                        <label>R√©capitulatif rapide des op√©rations r√©alis√©es</label>
                        <input type="text" value="${s.recap || ''}" oninput="updateField('recap',this.value)">
                    </div>
                    <div class="form-group">
                        <label>Actions r√©alis√©es</label>
                        <div id="actions-list">
                            ${s.actions.map((a, idx) => `
                                <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                                    <input type="text" value="${a.label}" style="width:200px" oninput="updateActionLabel(${idx},this.value)">
                                    <button class="counter-btn" onclick="updateActionCount(${idx},${a.count - 1})">‚àí</button>
                                    <span class="counter-display">${a.count}</span>
                                    <button class="counter-btn" onclick="updateActionCount(${idx},${a.count + 1})">+</button>
                                    <button class="close-btn" onclick="deleteAction(${idx})" title="Supprimer cette action">‚úñ</button>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="addAction()" style="margin-top:8px;">Ajouter une action</button>
                    </div>
                `
                }
            ];
            let html = "";
            cards.forEach((card, idx) => {
                html += `
            <div class="collapsible-card${s.collapsed[idx] ? ' collapsed' : ''}" id="card-${idx}">
                <div class="collapsible-header" onclick="toggleCard(${idx},event)">
                    <span>${card.title}</span>
                    <span>
                        <button class="close-btn" onclick="closeCard(event,${idx})" title="Fermer cette carte">‚úñ</button>
                        <span>${s.collapsed[idx] ? '‚ñ∂' : '‚ñº'}</span>
                    </span>
                </div>
                <div class="collapsible-content">${card.content}</div>
            </div>
            `;
            });
            document.getElementById('cards-container').innerHTML = html;
        }

        function renderTemplate() {
            const s = services[currentService];
            const pds = (s.pdsHour !== "" && s.pdsMinute !== "") ? `${String(s.pdsHour).padStart(2, '0')}h${String(s.pdsMinute).padStart(2, '0')}` : "";
            const fds = (s.fdsHour !== "" && s.fdsMinute !== "") ? `${String(s.fdsHour).padStart(2, '0')}h${String(s.fdsMinute).padStart(2, '0')}` : "";
            let total = "";
            if (s.pdsHour !== "" && s.pdsMinute !== "" && s.fdsHour !== "" && s.fdsMinute !== "") {
                let start = parseInt(s.pdsHour) * 60 + parseInt(s.pdsMinute);
                let end = parseInt(s.fdsHour) * 60 + parseInt(s.fdsMinute);
                if (end < start) end += 24 * 60;
                let diff = end - start;
                total = `${Math.floor(diff / 60)}h${String(diff % 60).padStart(2, '0')}`;
            }
            let actions = s.actions.filter(a => a.label.trim()).map(a => `${a.count}x ${a.label}`).filter(txt => !txt.startsWith("0x")).join(', ');
            document.getElementById('template-content').innerHTML = `
- <b>Rapide recap des op√©rations r√©alis√©es :</b> ${s.recap || ""}${actions ? (" ; " + actions) : ""}<br>
${total ? `<b>**Total : ${total}**</b>` : ""}
        `;
        }

        function updateField(field, value) {
            services[currentService][field] = value;
            saveServices();
            renderTemplate();
            if (field === "samsName") renderTabs();
        }
        function toggleCard(idx, e) {
            if (e.target.classList.contains('close-btn')) return;
            services[currentService].collapsed[idx] = !services[currentService].collapsed[idx];
            saveServices();
            renderCards();
        }
        function closeCard(e, idx) {
            e.stopPropagation();
            services[currentService].collapsed[idx] = true;
            saveServices();
            renderCards();
        }
        function addService() {
            services.push(defaultService());
            currentService = services.length - 1;
            saveServices();
            renderTabs();
            renderCards();
            renderTemplate();
        }
        function switchService(idx) {
            currentService = idx;
            saveServices();
            renderTabs();
            renderCards();
            renderTemplate();
        }
        function deleteService(e, idx) {
            e.stopPropagation();
            if (services.length <= 1) return;
            services.splice(idx, 1);
            if (currentService >= services.length) currentService = services.length - 1;
            saveServices();
            renderTabs();
            renderCards();
            renderTemplate();
        }
        function copyTemplate() {
            const templateText = document.getElementById('template-content').innerText;
            function showCopied(btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '‚úÖ <span>Copi√©!</span>';
                btn.style.background = 'rgba(34, 197, 94, 0.2)';
                btn.style.color = '#22c55e';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }
            const btn = document.querySelector('.copy-btn');
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(templateText).then(() => {
                    showCopied(btn);
                }).catch(function() {
                    // fallback
                    const textarea = document.createElement('textarea');
                    textarea.value = templateText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try { document.execCommand('copy'); showCopied(btn); } catch(e){}
                    document.body.removeChild(textarea);
                });
            } else {
                // fallback for insecure context or no clipboard API
                const textarea = document.createElement('textarea');
                textarea.value = templateText;
                document.body.appendChild(textarea);
                textarea.select();
                try { document.execCommand('copy'); showCopied(btn); } catch(e){}
                document.body.removeChild(textarea);
            }
        }
        function setNow(type) {
            const now = new Date();
            if (type === 'pds') {
                services[currentService].pdsHour = now.getHours();
                services[currentService].pdsMinute = now.getMinutes();
            } else if (type === 'fds') {
                services[currentService].fdsHour = now.getHours();
                services[currentService].fdsMinute = now.getMinutes();
            }
            saveServices();
            renderCards();
            renderTemplate();
        }
        function addAction() {
            services[currentService].actions.push({ label: "", count: 0 });
            saveServices();
            renderCards();
            renderTemplate();
        }
        function updateActionLabel(idx, value) {
            services[currentService].actions[idx].label = value;
            saveServices();
            renderTemplate();
        }
        function updateActionCount(idx, value) {
            services[currentService].actions[idx].count = Math.max(0, parseInt(value) || 0);
            saveServices();
            renderCards();
            renderTemplate();
        }
        function deleteAction(idx) {
            services[currentService].actions.splice(idx, 1);
            saveServices();
            renderCards();
            renderTemplate();
        }

        loadServices();
        renderTabs();
        renderCards();
        renderTemplate();

        // Gestion de l'affichage des onglets selon les sp√©cialit√©s
        function updateSpecialityTabs() {
            const params = JSON.parse(localStorage.getItem('sams_params') || '{}');
            
            const hasPH = params.specialities && params.specialities.includes('Pilote H√©liport√©');
            const hasProf = params.specialities && params.specialities.includes('Professeur');
            
            const phTab = document.getElementById('ph-tab');
            const profTab = document.getElementById('prof-tab');
            
            if (phTab) phTab.style.display = hasPH ? 'block' : 'none';
            if (profTab) profTab.style.display = hasProf ? 'block' : 'none';
        }
        
        // Appel au chargement de la page
        document.addEventListener('DOMContentLoaded', updateSpecialityTabs);
        
        fetch('json/changelog.json')
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data) && data.length > 0) {
                    document.querySelector('.header span').textContent = data[0].version;
                }
            });
    </script>
</body>

</html>