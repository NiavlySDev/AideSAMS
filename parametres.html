<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres - Aide SAMS</title>
    <link rel="stylesheet" href="style.css">
    <script src="update-notifier.js"></script>
</head>

<body>

    <div class="header"
        style="display:flex;align-items:center;justify-content:center;gap:18px;margin-top:18px;margin-bottom:18px;">
        <h1 style="margin:0;text-align:center;">Aide SAMS</h1>
        <div style="display:flex;align-items:center;gap:12px;margin-left:18px;">
            <span
                style="background:#22c55e;color:#181818;padding:6px 16px;border-radius:8px;font-weight:bold;font-size:1.05em;">
                v...
            </span>
            <button class="btn" onclick="location.href='informations.html'"
                style="background:#181818;color:#22c55e;border:1px solid #22c55e;">
                ‚ÑπÔ∏è Informations
            </button>
        </div>
    </div>
    <nav class="nav-tabs">
        <button class="nav-tab" onclick="location.href='service.html'">Service</button>
        <button class="nav-tab" onclick="location.href='rapport.html'">Rapport de soins</button>
        <button class="nav-tab" onclick="location.href='refus_de_soin.html'">Refus de soins</button>
        <button class="nav-tab" onclick="location.href='morgue.html'">Morgue</button>
        <button class="nav-tab" onclick="location.href='impayes.html'">Impay√©s</button>
        <button class="nav-tab" onclick="location.href='lspd.html'">LSPD</button>
        <button class="nav-tab" id="ph-tab" onclick="location.href='ph.html'">PH</button>
        <button class="nav-tab" id="prof-tab" onclick="location.href='professeur.html'">Professeur</button>
        <button class="nav-tab" onclick="location.href='manuels.html'">Manuels</button>
        <button class="nav-tab" onclick="location.href='documents.html'">Documents</button>
        <button class="nav-tab" onclick="location.href='suggestions.html'">Suggestions/Bugs</button>
        <button class="nav-tab" onclick="location.href='hierarchie.html'">Hi√©rarchie</button>
        <button class="nav-tab active" onclick="location.href='parametres.html'">Param√®tres</button>
    </nav>

    <div class="main-container" style="display:flex;justify-content:center;align-items:center;min-height:70vh;">
        <div class="card"
            style="margin-top:32px; width:100%; max-width:500px; min-width:350px; padding:40px 32px; box-sizing:border-box;">
            <h2 style="text-align:center;">Param√®tres personnels</h2>
            <div class="form-group">
                <label for="samsName">Votre Pr√©nom et Nom :</label>
                <input type="text" id="samsName" placeholder="Ex: Jason Parker">
            </div>
            <div class="form-group">
                <label for="samsId">Votre ID :</label>
                <input type="text" id="samsId" placeholder="Ex: 37833">
            </div>
            <div class="form-group">
                <label for="samsGrade">Votre Grade :</label>
                <select id="samsGrade" onchange="updateEchelonOptions()">
                    <option value="">-- S√©lectionnez votre grade --</option>
                    <option value="emt">EMT</option>
                    <option value="infirmier-clinique">Infirmier Clinique</option>
                    <option value="paramedic">Param√©dic</option>
                    <option value="paramedic-chef">Param√©dic Chef</option>
                    <option value="medecin">M√©decin</option>
                    <option value="medecin-urgentiste">M√©decin Urgentiste</option>
                    <option value="secretaire">Secr√©taire</option>
                    <option value="chef-service-infirmier">Chef de Service Infirmier</option>
                    <option value="chef-service-paramedic">Chef de Service Param√©dic</option>
                    <option value="chef-service-medecin">Chef de Service M√©decin</option>
                    <option value="superviseur">Superviseur</option>
                    <option value="directeur-adjoint">Directeur Adjoint</option>
                    <option value="directeur">Directeur</option>
                </select>
            </div>
            <div class="form-group" id="echelonGroup" style="display:none;">
                <label for="samsEchelon">√âchelon :</label>
                <select id="samsEchelon">
                    <option value="">-- S√©lectionnez l'√©chelon --</option>
                </select>
            </div>
            <div class="form-group">
                <label>Sp√©cialit√©s :</label>
                <div style="margin-top:8px;">
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-ph" value="Pilote H√©liport√©">
                        <label for="spec-ph" style="margin-left:8px;">Pilote H√©liport√©</label>
                    </div>
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-prof" value="Professeur">
                        <label for="spec-prof" style="margin-left:8px;">Professeur</label>
                    </div>
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-legiste" value="M√©decin L√©giste">
                        <label for="spec-legiste" style="margin-left:8px;">M√©decin L√©giste</label>
                    </div>
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-psychologue" value="Psychologue">
                        <label for="spec-psychologue" style="margin-left:8px;">Psychologue</label>
                    </div>
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-assistant" value="Assistant Direction">
                        <label for="spec-assistant" style="margin-left:8px;">Assistant Direction</label>
                    </div>
                    <div style="margin:6px 0;">
                        <input type="checkbox" id="spec-strapz" value="STRAPZ">
                        <label for="spec-strapz" style="margin-left:8px;">STRAPZ</label>
                    </div>
                </div>
            </div>

            <!-- Section Signatures -->
            <div class="param-section" style="margin-top:24px;">
                <h3>üìù Gestion des Signatures</h3>
                <p style="color:#aaa;margin-bottom:16px;">G√©rez vos signatures sauvegard√©es pour les documents m√©dicaux.</p>
                
                <div id="signatures-list" class="signatures-list">
                    <!-- Les signatures sauvegard√©es seront affich√©es ici -->
                </div>
                
                <div style="display:flex;gap:12px;margin-top:16px;">
                    <button class="btn" onclick="createNewSignature()" style="background:#3b82f6;color:white;">
                        ‚úçÔ∏è Cr√©er une nouvelle signature
                    </button>
                    <button class="btn" onclick="clearAllSignatures()" style="background:#ef4444;color:white;">
                        üóëÔ∏è Supprimer toutes les signatures
                    </button>
                </div>
            </div>

            <button class="btn" onclick="saveParams()"
                style="margin-top:24px;display:block;margin-left:auto;margin-right:auto;">üíæ Enregistrer</button>
            <span id="save-status" style="margin-left:16px;color:#22c55e;display:none;">Enregistr√© !</span>
        </div>
    </div>

    <!-- Modal pour cr√©er une signature -->
    <div id="signatureModal" class="modal" style="display:none;">
        <div class="modal-content" style="background:#1a1a1b;border-radius:12px;border:1px solid rgba(64,64,68,0.3);max-width:600px;">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(64,64,68,0.3);background:rgba(30,30,32,0.8);border-radius:12px 12px 0 0;">
                <h3 style="color:#22c55e;margin:0;">Cr√©er une nouvelle signature</h3>
                <span class="close" onclick="closeSignatureModal()" style="color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:1;">&times;</span>
            </div>
            <div class="modal-body" style="padding:1.5rem;">
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:8px;color:#e5e5e5;">Nom de la signature:</label>
                    <input type="text" id="signatureName" placeholder="Ex: Ma signature principale" style="width:100%;background:#2a2a2c;border:1px solid #404044;color:#e5e5e5;padding:10px;border-radius:6px;">
                </div>
                <div style="margin-bottom:20px;">
                    <canvas id="newSignatureCanvas" width="400" height="150" style="border:2px solid #404044;border-radius:8px;background:white;display:block;margin:0 auto;cursor:crosshair;"></canvas>
                </div>
                <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;">
                    <button class="btn" onclick="clearNewSignature()">Effacer</button>
                    <button class="btn" onclick="saveNewSignature()" style="background:#22c55e;color:#181818;">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateEchelonOptions() {
            const grade = document.getElementById('samsGrade').value;
            const echelonGroup = document.getElementById('echelonGroup');
            const echelonSelect = document.getElementById('samsEchelon');
            
            // Efface les options actuelles
            echelonSelect.innerHTML = '<option value="">-- S√©lectionnez l\'√©chelon --</option>';
            
            if (grade === 'paramedic' || grade === 'paramedic-chef') {
                echelonGroup.style.display = 'block';
                echelonSelect.innerHTML += '<option value="1">√âchelon 1</option>';
                echelonSelect.innerHTML += '<option value="2">√âchelon 2</option>';
                echelonSelect.innerHTML += '<option value="3">√âchelon 3</option>';
                echelonSelect.innerHTML += '<option value="superieur">Sup√©rieur</option>';
            } else if (grade === 'medecin') {
                echelonGroup.style.display = 'block';
                echelonSelect.innerHTML += '<option value="1">√âchelon 1</option>';
                echelonSelect.innerHTML += '<option value="2">√âchelon 2</option>';
                echelonSelect.innerHTML += '<option value="3">√âchelon 3</option>';
            } else if (grade === 'medecin-urgentiste') {
                echelonGroup.style.display = 'block';
                echelonSelect.innerHTML += '<option value="1">√âchelon 1</option>';
                echelonSelect.innerHTML += '<option value="2">√âchelon 2</option>';
            } else {
                echelonGroup.style.display = 'none';
            }
        }

        function loadParams() {
            const params = JSON.parse(localStorage.getItem('sams_params') || '{}');
            if (params.samsName) document.getElementById('samsName').value = params.samsName;
            if (params.samsId) document.getElementById('samsId').value = params.samsId;
            if (params.samsGrade) {
                document.getElementById('samsGrade').value = params.samsGrade;
                updateEchelonOptions();
                if (params.samsEchelon) {
                    document.getElementById('samsEchelon').value = params.samsEchelon;
                }
            }
            if (params.specialities) {
                params.specialities.forEach(spec => {
                    const checkbox = document.querySelector(`input[value="${spec}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        function saveParams() {
            const samsName = document.getElementById('samsName').value.trim();
            const samsId = document.getElementById('samsId').value.trim();
            const samsGrade = document.getElementById('samsGrade').value;
            const samsEchelon = document.getElementById('samsEchelon').value;
            
            // R√©cup√®re les sp√©cialit√©s coch√©es
            const specialities = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                specialities.push(checkbox.value);
            });
            
            const params = {
                samsName,
                samsId,
                samsGrade,
                samsEchelon,
                specialities
            };
            
            localStorage.setItem('sams_params', JSON.stringify(params));
            
            // Affiche confirmation
            const status = document.getElementById('save-status');
            status.style.display = 'inline';
            setTimeout(() => { status.style.display = 'none'; }, 2000);
            
            // Met √† jour la visibilit√© de l'onglet PH
            updateNavigation();
        }
        
        function updateNavigation() {
            // Cette fonction sera appel√©e pour mettre √† jour la navigation selon les sp√©cialit√©s
            const params = JSON.parse(localStorage.getItem('sams_params') || '{}');
            
            const hasPH = params.specialities && params.specialities.includes('Pilote H√©liport√©');
            const hasProf = params.specialities && params.specialities.includes('Professeur');
            
            const phTab = document.getElementById('ph-tab');
            const profTab = document.getElementById('prof-tab');
            
            if (phTab) phTab.style.display = hasPH ? 'block' : 'none';
            if (profTab) profTab.style.display = hasProf ? 'block' : 'none';
        }

        // Gestion de l'affichage de l'onglet PH selon les sp√©cialit√©s
        function updatePHTabVisibility() {
            const hasPH = localStorage.getItem('has_ph_speciality') === '1';
            const phTab = document.getElementById('ph-tab');
            if (phTab) {
                phTab.style.display = hasPH ? 'block' : 'none';
            }
        }
        
        // Appel au chargement de la page
        document.addEventListener('DOMContentLoaded', updatePHTabVisibility);

        loadParams();
        updateNavigation();
        loadSignaturesList();

        // Gestion des signatures
        let newSignatureCanvas = null;
        let newSignatureCtx = null;
        let isDrawing = false;

        function loadSignaturesList() {
            const signatures = JSON.parse(localStorage.getItem('sams_signatures') || '[]');
            const container = document.getElementById('signatures-list');
            
            if (signatures.length === 0) {
                container.innerHTML = '<p style="color:#aaa;text-align:center;padding:20px;">Aucune signature sauvegard√©e</p>';
                return;
            }
            
            container.innerHTML = signatures.map(sig => `
                <div class="signature-item" style="display:flex;align-items:center;justify-content:space-between;background:#2a2a2c;border:1px solid #404044;border-radius:8px;padding:12px;margin-bottom:8px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div style="background:white;padding:8px;border-radius:4px;min-width:100px;height:40px;display:flex;align-items:center;justify-content:center;">
                            ${sig.type === 'drawn' ? `<img src="${sig.dataURL}" style="max-width:90px;max-height:30px;">` : `<span style="font-family:'${sig.font}',cursive;color:#000;font-size:16px;">${sig.text}</span>`}
                        </div>
                        <div>
                            <div style="font-weight:500;">${sig.name}</div>
                            <div style="color:#aaa;font-size:12px;">Cr√©√©e le ${new Date(sig.created).toLocaleDateString('fr-FR')}</div>
                        </div>
                    </div>
                    <button class="btn" onclick="deleteSignature(${sig.id})" style="background:#ef4444;color:white;padding:6px 12px;font-size:12px;">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            `).join('');
        }

        function createNewSignature() {
            document.getElementById('signatureModal').style.display = 'block';
            setTimeout(() => {
                initNewSignatureCanvas();
            }, 100);
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            document.getElementById('signatureName').value = '';
            if (newSignatureCanvas) {
                newSignatureCtx.clearRect(0, 0, newSignatureCanvas.width, newSignatureCanvas.height);
            }
        }

        function initNewSignatureCanvas() {
            newSignatureCanvas = document.getElementById('newSignatureCanvas');
            newSignatureCtx = newSignatureCanvas.getContext('2d');
            
            newSignatureCtx.strokeStyle = '#000000';
            newSignatureCtx.lineWidth = 2;
            newSignatureCtx.lineCap = 'round';
            newSignatureCtx.lineJoin = 'round';
            
            newSignatureCanvas.addEventListener('mousedown', startNewSignatureDrawing);
            newSignatureCanvas.addEventListener('mousemove', drawNewSignature);
            newSignatureCanvas.addEventListener('mouseup', stopNewSignatureDrawing);
            newSignatureCanvas.addEventListener('mouseout', stopNewSignatureDrawing);
            
            // Touch events for mobile
            newSignatureCanvas.addEventListener('touchstart', handleNewSignatureTouch);
            newSignatureCanvas.addEventListener('touchmove', handleNewSignatureTouch);
            newSignatureCanvas.addEventListener('touchend', stopNewSignatureDrawing);
        }

        function startNewSignatureDrawing(e) {
            isDrawing = true;
            const rect = newSignatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            newSignatureCtx.beginPath();
            newSignatureCtx.moveTo(x, y);
        }

        function drawNewSignature(e) {
            if (!isDrawing) return;
            
            const rect = newSignatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            newSignatureCtx.lineTo(x, y);
            newSignatureCtx.stroke();
        }

        function stopNewSignatureDrawing() {
            isDrawing = false;
            newSignatureCtx.beginPath();
        }

        function handleNewSignatureTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            newSignatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearNewSignature() {
            if (newSignatureCanvas) {
                newSignatureCtx.clearRect(0, 0, newSignatureCanvas.width, newSignatureCanvas.height);
            }
        }

        function saveNewSignature() {
            const name = document.getElementById('signatureName').value.trim();
            
            if (!name) {
                alert('Veuillez entrer un nom pour la signature');
                return;
            }
            
            // Check if canvas has content
            const imageData = newSignatureCtx.getImageData(0, 0, newSignatureCanvas.width, newSignatureCanvas.height);
            let hasContent = false;
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] > 0) { // Check alpha channel
                    hasContent = true;
                    break;
                }
            }
            
            if (!hasContent) {
                alert('Veuillez dessiner votre signature avant de sauvegarder');
                return;
            }
            
            const signatures = JSON.parse(localStorage.getItem('sams_signatures') || '[]');
            const newSignature = {
                id: Date.now(),
                name: name,
                dataURL: newSignatureCanvas.toDataURL('image/png'),
                type: 'drawn',
                created: new Date().toISOString()
            };
            
            signatures.push(newSignature);
            localStorage.setItem('sams_signatures', JSON.stringify(signatures));
            
            closeSignatureModal();
            loadSignaturesList();
            
            showSaveStatus('Signature sauvegard√©e !');
        }

        function deleteSignature(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette signature ?')) {
                let signatures = JSON.parse(localStorage.getItem('sams_signatures') || '[]');
                signatures = signatures.filter(sig => sig.id !== id);
                localStorage.setItem('sams_signatures', JSON.stringify(signatures));
                loadSignaturesList();
                showSaveStatus('Signature supprim√©e');
            }
        }

        function clearAllSignatures() {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer TOUTES les signatures ? Cette action est irr√©versible.')) {
                localStorage.removeItem('sams_signatures');
                loadSignaturesList();
                showSaveStatus('Toutes les signatures ont √©t√© supprim√©es');
            }
        }

        function showSaveStatus(message) {
            const status = document.getElementById('save-status');
            status.textContent = message;
            status.style.display = 'inline';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // Close modal on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('signatureModal');
            if (event.target === modal) {
                closeSignatureModal();
            }
        };
    </script>
    <script>
        fetch('json/changelog.json')
            .then(res => res.json())
            .then(data => {
                if (Array.isArray(data) && data.length > 0) {
                    document.querySelector('.header span').textContent = data[0].version;
                }
            });
    </script>
</body>

</html>