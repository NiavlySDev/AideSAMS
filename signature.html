<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature de Document - AideSAMS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .signature-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8B0000, #DC143C);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 20px;
        }

        .hospital-name {
            color: #DC143C;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-style: italic;
            margin-bottom: 30px;
        }

        .document-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .document-preview {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            font-size: 14px;
        }

        .signature-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
        }

        .signature-canvas {
            width: 100%;
            height: 200px;
            border: 3px solid #007bff;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease;
        }
        
        .signature-canvas:hover {
            border-color: #0056b3;
        }
        
        .signature-canvas.signing {
            border-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error {
            color: #e74c3c;
            background: #ffeaea;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #eafaf1;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #27ae60;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .document-field {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .document-field strong {
            display: inline-block;
            width: 150px;
            color: #333;
        }

        .signature-info {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .signature-container {
                padding: 20px;
                margin: 10px;
            }
            
            .signature-canvas {
                height: 150px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="signature-container">
        <div class="logo">üè•</div>
        <div class="hospital-name">San Andreas Medical Services</div>
        <div class="subtitle">Notre Priorit√©, Votre Sant√©</div>

        <div id="loadingSection">
            <div class="loading"></div>
            Chargement du document...
        </div>

        <div id="errorSection" class="error" style="display: none;"></div>

        <div id="documentSection" style="display: none;">
            <h2>Document √† signer</h2>
            
            <div class="document-info">
                <div class="document-field">
                    <strong>Type de document:</strong>
                    <span id="documentType"></span>
                </div>
                <div class="document-field">
                    <strong>M√©decin traitant:</strong>
                    <span id="doctorName"></span>
                </div>
                <div class="document-field">
                    <strong>Date d'√©mission:</strong>
                    <span id="documentDate"></span>
                </div>
                <div class="document-field">
                    <strong>Email du patient:</strong>
                    <span id="patientEmail"></span>
                </div>
                <div class="document-field">
                    <strong>Expire le:</strong>
                    <span id="expiryDate"></span>
                </div>
            </div>

            <div class="document-preview" id="documentPreview">
                <!-- Le contenu du document sera ins√©r√© ici -->
            </div>

            <div class="signature-section">
                <h3>Votre signature</h3>
                <div class="signature-info">
                    <strong>Instructions :</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>Signez dans la zone ci-dessous avec votre souris ou votre doigt</li>
                        <li>Votre signature sera ajout√©e au document m√©dical</li>
                        <li>Une fois sign√©, le document ne pourra plus √™tre modifi√©</li>
                        <li>Le m√©decin sera notifi√© de votre signature</li>
                    </ul>
                </div>
                
                <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                
                <div>
                    <button class="btn secondary" onclick="clearSignature()">üóëÔ∏è Effacer</button>
                    <button class="btn" onclick="testCanvas()" style="background: #ff6b35;">üß™ Test Canvas</button>
                    <button class="btn" onclick="diagnoseCanvas()" style="background: #9b59b6;">üîç Diagnostic</button>
                    <button class="btn success" onclick="submitSignature()" id="submitBtn" disabled>‚úì Signer le document</button>
                </div>
            </div>
        </div>

        <div id="successSection" class="success" style="display: none;">
            <h3>‚úÖ Document sign√© avec succ√®s !</h3>
            <p>Votre signature a √©t√© enregistr√©e et le m√©decin a √©t√© notifi√©.</p>
            <p>Vous pouvez fermer cette page.</p>
        </div>

        <div id="alreadySignedSection" class="error" style="display: none;">
            <h3>Document d√©j√† sign√©</h3>
            <p>Ce document a d√©j√† √©t√© sign√© et ne peut plus √™tre modifi√©.</p>
        </div>
    </div>

    <script>
        let isDrawing = false;
        let canvas = null;
        let ctx = null;
        let documentData = null;
        let hasSignature = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            loadDocument();
        });

        function initializeCanvas() {
            canvas = document.getElementById('signatureCanvas');
            if (!canvas) {
                console.error('Canvas element not found!');
                return;
            }
            
            ctx = canvas.getContext('2d');
            
            // Attendre que l'√©l√©ment soit visible et ait des dimensions
            setTimeout(() => {
                setupCanvas();
            }, 100);
        }

        function setupCanvas() {
            // D√©finir des dimensions fixes si le canvas n'a pas de taille
            const rect = canvas.getBoundingClientRect();
            const width = rect.width > 0 ? rect.width : 400;
            const height = rect.height > 0 ? rect.height : 200;
            
            // D√©finir les dimensions du canvas
            canvas.width = width;
            canvas.height = height;
            
            // Appliquer les styles explicitement
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            // Style de la signature
            ctx.strokeStyle = '#000000'; // Noir explicite
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Fond blanc pour √©viter la transparence
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            console.log('Canvas initialized:', canvas.width, 'x', canvas.height);
            
            // √âv√©nements souris
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // √âv√©nements tactiles
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            if (!canvas || !ctx) {
                console.error('Canvas not initialized');
                return;
            }
            
            e.preventDefault();
            isDrawing = true;
            canvas.classList.add('signing');
            
            const coords = getMousePos(e);
            
            // S'assurer que le style est correct
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
            
            hasSignature = true;
            updateSubmitButton();
            
            console.log('Start drawing at:', coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing || !canvas || !ctx) return;
            
            e.preventDefault();
            const coords = getMousePos(e);
            
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            
            console.log('Drawing to:', coords.x, coords.y);
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function stopDrawing() {
            if (isDrawing) {
                canvas.classList.remove('signing');
                ctx.beginPath();
                isDrawing = false;
            }
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (!canvas || !ctx) {
                console.warn('Canvas ou contexte non disponible pour effacer');
                return;
            }
            
            console.log('Effacement de la signature...');
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Remettre un fond blanc bien visible
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ajouter une bordure subtile pour indiquer la zone de signature
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);
            
            hasSignature = false;
            updateSubmitButton();
            
            console.log('Signature cleared - canvas r√©initialis√©');
        }

        function testCanvas() {
            if (!canvas || !ctx) {
                console.error('Canvas not available for test');
                return;
            }
            
            // Dessiner un carr√© de test
            ctx.fillStyle = 'red';
            ctx.fillRect(50, 50, 100, 100);
            ctx.strokeStyle = 'blue';
            ctx.lineWidth = 5;
            ctx.strokeRect(50, 50, 100, 100);
            
            console.log('Test rectangle drawn');
        }

        // Fonction de diagnostic complet
        function diagnoseCanvas() {
            console.log('=== DIAGNOSTIC CANVAS ===');
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) {
                console.error('Canvas non trouv√© !');
                return;
            }

            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const computedStyle = window.getComputedStyle(canvas);

            console.log('Canvas trouv√©:', canvas);
            console.log('Context 2D:', ctx);
            console.log('Dimensions canvas:', {
                width: canvas.width,
                height: canvas.height,
                clientWidth: canvas.clientWidth,
                clientHeight: canvas.clientHeight,
                offsetWidth: canvas.offsetWidth,
                offsetHeight: canvas.offsetHeight
            });
            console.log('Position:', {
                top: rect.top,
                left: rect.left,
                right: rect.right,
                bottom: rect.bottom,
                width: rect.width,
                height: rect.height
            });
            console.log('Style CSS:', {
                width: computedStyle.width,
                height: computedStyle.height,
                display: computedStyle.display,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity,
                backgroundColor: computedStyle.backgroundColor,
                border: computedStyle.border
            });

            // Test de dessin visible avec fond blanc
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Fond blanc pour contraste
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Bordure noire pour d√©limiter
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);
            
            // Test de texte
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('DIAGNOSTIC - Canvas OK', 20, 30);
            
            // Croix centrale rouge
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(centerX - 20, centerY - 20);
            ctx.lineTo(centerX + 20, centerY + 20);
            ctx.moveTo(centerX + 20, centerY - 20);
            ctx.lineTo(centerX - 20, centerY + 20);
            ctx.stroke();
            
            console.log('Test de diagnostic effectu√© - v√©rifiez visuellement le canvas');
            return true;
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = !hasSignature;
        }

        function loadDocument() {
            // R√©cup√©rer l'ID du document depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('id');
            
            if (!documentId) {
                showError('Lien invalide - ID de document manquant');
                return;
            }
            
            // Charger le document depuis localStorage (simulation)
            const sharedDocuments = JSON.parse(localStorage.getItem('sharedDocuments') || '[]');
            documentData = sharedDocuments.find(doc => doc.id === documentId);
            
            if (!documentData) {
                showError('Document introuvable ou lien expir√©');
                return;
            }
            
            // V√©rifier l'expiration
            const now = new Date();
            const expiryDate = new Date(documentData.expiresAt);
            
            if (now > expiryDate) {
                showError('Ce lien a expir√©. Veuillez contacter votre m√©decin pour un nouveau lien.');
                return;
            }
            
            // V√©rifier si d√©j√† sign√©
            if (documentData.signed) {
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('alreadySignedSection').style.display = 'block';
                return;
            }
            
            // Afficher le document
            displayDocument();
        }

        function displayDocument() {
            // Masquer la section de chargement
            document.getElementById('loadingSection').style.display = 'none';
            
            // Remplir les informations
            document.getElementById('documentType').textContent = getDocumentTypeName(documentData.type);
            document.getElementById('doctorName').textContent = getDoctorName();
            document.getElementById('documentDate').textContent = new Date().toLocaleDateString('fr-FR');
            document.getElementById('patientEmail').textContent = documentData.patientEmail;
            document.getElementById('expiryDate').textContent = new Date(documentData.expiresAt).toLocaleString('fr-FR');
            
            // G√©n√©rer l'aper√ßu du document
            generateDocumentPreview();
            
            // Afficher la section principale
            document.getElementById('documentSection').style.display = 'block';
            
            // S'assurer que le canvas est bien initialis√© apr√®s l'affichage
            setTimeout(() => {
                console.log('Re-initialisation du canvas apr√®s affichage du document');
                initializeCanvas();
            }, 100);
        }

        function getDocumentTypeName(type) {
            const types = {
                'arret_travail': 'Avis d\'arr√™t de travail',
                'certificat_naissance': 'Certificat de naissance',
                'facture_hospitalisation': 'Facture d\'hospitalisation'
            };
            return types[type] || type;
        }

        function getDoctorName() {
            const data = documentData.data;
            if (data.medecin_nom && data.medecin_prenom) {
                return `Dr. ${data.medecin_prenom} ${data.medecin_nom}`;
            }
            if (data.medecin_nom_cert) {
                return `Dr. ${data.medecin_nom_cert}`;
            }
            if (data.facture_medecin) {
                return `Dr. ${data.facture_medecin}`;
            }
            return 'M√©decin non sp√©cifi√©';
        }

        function generateDocumentPreview() {
            const preview = document.getElementById('documentPreview');
            const data = documentData.data;
            let content = '';
            
            switch (documentData.type) {
                case 'arret_travail':
                    content = `
                        <h4>Avis d'arr√™t de travail</h4>
                        <p><strong>Patient:</strong> ${data.patient_prenom || ''} ${data.patient_nom || ''}</p>
                        <p><strong>ID Patient:</strong> ${data.patient_id || ''}</p>
                        <p><strong>Date de naissance:</strong> ${data.patient_naissance || ''}</p>
                        <p><strong>M√©decin:</strong> Dr. ${data.medecin_prenom || ''} ${data.medecin_nom || ''}</p>
                        <p><strong>P√©riode d'arr√™t:</strong> Du ${data.arret_debut || ''} au ${data.arret_fin || ''}</p>
                        <p><strong>Travail possible:</strong> ${data.travail_possible || 'Non'}</p>
                        <p><strong>Raison:</strong> ${data.raison_arret || ''}</p>
                    `;
                    break;
                    
                case 'certificat_naissance':
                    content = `
                        <h4>Certificat de naissance</h4>
                        <p><strong>Enfant:</strong> ${data.enfant_prenom || ''} ${data.enfant_nom || ''}</p>
                        <p><strong>Date de naissance:</strong> ${data.enfant_naissance || ''}</p>
                        <p><strong>Sexe:</strong> ${data.enfant_sexe || ''}</p>
                        <p><strong>Poids:</strong> ${data.enfant_poids || ''}</p>
                        <p><strong>Taille:</strong> ${data.enfant_taille || ''}</p>
                        <p><strong>M√®re:</strong> ${data.mere_nom || ''}</p>
                        <p><strong>P√®re:</strong> ${data.pere_nom || ''}</p>
                        <p><strong>M√©decin:</strong> ${data.medecin_nom_cert || ''}</p>
                    `;
                    break;
                    
                case 'facture_hospitalisation':
                    content = `
                        <h4>Facture d'hospitalisation</h4>
                        <p><strong>Patient:</strong> ${data.facture_patient || ''}</p>
                        <p><strong>Date de la facture:</strong> ${data.facture_date_emission || ''}</p>
                        <p><strong>M√©decin traitant:</strong> ${data.facture_medecin || ''}</p>
                        <p><strong>Total des frais:</strong> ${data.total_general || ''}</p>
                        <h5>D√©tail des soins:</h5>
                        <ul>
                            ${data.soins_total ? `<li>Soins: ${data.soins_total}</li>` : ''}
                            ${data.medicaments_total ? `<li>M√©dicaments: ${data.medicaments_total}</li>` : ''}
                            ${data.radio_total ? `<li>Radiologie: ${data.radio_total}</li>` : ''}
                            ${data.chirurgie_total ? `<li>Chirurgie: ${data.chirurgie_total}</li>` : ''}
                        </ul>
                    `;
                    break;
            }
            
            preview.innerHTML = content;
        }

        async function submitSignature() {
            if (!hasSignature) {
                alert('Veuillez d\'abord signer le document');
                return;
            }
            
            // Capturer la signature
            const signatureData = canvas.toDataURL();
            
            // Mettre √† jour le document
            documentData.signed = true;
            documentData.patientSignature = signatureData;
            documentData.signedAt = new Date().toISOString();
            
            // Sauvegarder dans localStorage
            let sharedDocuments = JSON.parse(localStorage.getItem('sharedDocuments') || '[]');
            const index = sharedDocuments.findIndex(doc => doc.id === documentData.id);
            if (index >= 0) {
                sharedDocuments[index] = documentData;
                localStorage.setItem('sharedDocuments', JSON.stringify(sharedDocuments));
            }
            
            // Cr√©er le document complet avec signature int√©gr√©e
            const fullDocument = await createSignedDocument(signatureData);
            
            // Simuler la notification au m√©decin
            console.log('Notification envoy√©e au m√©decin:', documentData);
            
            // Afficher le document sign√© et l'option de t√©l√©chargement
            displaySignedDocument(fullDocument);
        }

        async function createSignedDocument(signatureData) {
            // Cr√©er une copie compl√®te du document avec signature
            const documentContainer = document.createElement('div');
            documentContainer.className = 'document-container';
            documentContainer.style.background = 'white';
            documentContainer.style.padding = '40px';
            documentContainer.style.maxWidth = '800px';
            documentContainer.style.margin = '20px auto';
            documentContainer.style.fontFamily = 'Arial, sans-serif';

            let content = '';

            if (documentData.type === 'certificat_naissance') {
                content = `
                    <div class="document-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(45deg, #8B0000, #DC143C); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; margin-bottom: 10px;">üè•</div>
                            <div style="margin-left: 20px;">
                                <h2 style="margin: 0; color: #333;">San Andreas Medical Services</h2>
                                <p style="margin: 0; font-style: italic;">Notre Priorit√©, Votre Sant√©</p>
                            </div>
                        </div>
                        <div class="date-section" style="text-align: right;">
                            <p style="margin: 0; color: #666;">Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p style="margin: 0; color: #666;">Heure: ${new Date().toLocaleTimeString('fr-FR')}</p>
                        </div>
                    </div>

                    <div class="document-content">
                        <h1 style="text-align: center; color: #8B0000; margin: 30px 0; text-decoration: underline;">CERTIFICAT DE NAISSANCE</h1>
                        
                        <div class="info-section">
                            <h3 style="color: #333; border-bottom: 1px solid #ccc;">Informations de l'enfant</h3>
                            <p><strong>Nom de famille:</strong> ${documentData.data.enfant_nom || ''}</p>
                            <p><strong>Pr√©nom:</strong> ${documentData.data.enfant_prenom || ''}</p>
                            <p><strong>Date de naissance:</strong> ${documentData.data.enfant_naissance || ''}</p>
                            <p><strong>Lieu de naissance:</strong> ${documentData.data.enfant_lieu || ''}</p>
                            <p><strong>Sexe:</strong> ${documentData.data.enfant_sexe || ''}</p>
                            <p><strong>Poids:</strong> ${documentData.data.enfant_poids || ''} kg</p>
                            <p><strong>Taille:</strong> ${documentData.data.enfant_taille || ''} cm</p>
                        </div>

                        <div class="info-section">
                            <h3 style="color: #333; border-bottom: 1px solid #ccc;">Informations de la m√®re</h3>
                            <p><strong>Nom:</strong> ${documentData.data.mere_nom || ''}</p>
                            <p><strong>Pr√©nom:</strong> ${documentData.data.mere_prenom || ''}</p>
                            <p><strong>Date de naissance:</strong> ${documentData.data.mere_naissance || ''}</p>
                            <p><strong>Lieu de naissance:</strong> ${documentData.data.mere_lieu || ''}</p>
                            <p><strong>Profession:</strong> ${documentData.data.mere_profession || ''}</p>
                        </div>

                        <div class="info-section">
                            <h3 style="color: #333; border-bottom: 1px solid #ccc;">Informations du p√®re</h3>
                            <p><strong>Nom:</strong> ${documentData.data.pere_nom || ''}</p>
                            <p><strong>Pr√©nom:</strong> ${documentData.data.pere_prenom || ''}</p>
                            <p><strong>Date de naissance:</strong> ${documentData.data.pere_naissance || ''}</p>
                            <p><strong>Lieu de naissance:</strong> ${documentData.data.pere_lieu || ''}</p>
                            <p><strong>Profession:</strong> ${documentData.data.pere_profession || ''}</p>
                        </div>

                        <div class="signature-area" style="display: flex; justify-content: space-between; margin-top: 50px; gap: 50px;">
                            <div class="signature-box" style="flex: 1;">
                                <div class="signature-label" style="font-weight: bold; margin-bottom: 10px;">Signature du m√©decin</div>
                                <div style="height: 120px; border: 1px solid #ccc; background: #f9f9f9;"></div>
                            </div>
                            <div class="signature-box" style="flex: 1;">
                                <div class="signature-label" style="font-weight: bold; margin-bottom: 10px;">Signature des parents</div>
                                <div style="height: 120px; border: 1px solid #ccc; background: white; background-image: url('${signatureData}'); background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
                            </div>
                        </div>

                        <div class="certification" style="margin-top: 30px; text-align: center; font-style: italic;">
                            <p>Je certifie l'exactitude des informations mentionn√©es ci-dessus.</p>
                            <p><strong>Dr. ${documentData.data.medecin_nom_cert || 'M√©decin'}</strong></p>
                            <p>Sign√© √©lectroniquement le ${new Date().toLocaleString('fr-FR')}</p>
                        </div>
                    </div>
                `;
            }

            documentContainer.innerHTML = content;
            return documentContainer;
        }

        function displaySignedDocument(documentElement) {
            // Masquer la section de signature
            document.getElementById('documentSection').style.display = 'none';
            
            // Cr√©er une nouvelle section pour le document sign√©
            const signedSection = document.createElement('div');
            signedSection.id = 'signedDocumentSection';
            signedSection.innerHTML = `
                <div class="success" style="margin: 20px 0; padding: 20px; border-radius: 10px; background: #d4edda; border: 1px solid #c3e6cb;">
                    <h3 style="color: #155724;">‚úÖ Document sign√© avec succ√®s !</h3>
                    <p>Votre signature a √©t√© ajout√©e au certificat de naissance.</p>
                    <div style="margin: 20px 0;">
                        <button class="btn success" onclick="downloadSignedPDF()" style="margin-right: 10px;">üì• T√©l√©charger PDF</button>
                        <button class="btn" onclick="printDocument()" style="margin-right: 10px;">üñ®Ô∏è Imprimer</button>
                        <button class="btn secondary" onclick="window.close()">‚ùå Fermer</button>
                    </div>
                </div>
                
                <div id="signedDocumentContainer" style="border: 2px solid #28a745; border-radius: 10px; padding: 20px; background: #f8f9fa;">
                    <h4 style="color: #28a745; text-align: center;">Document sign√© - Pr√™t √† t√©l√©charger</h4>
                </div>
            `;

            // Ajouter le document sign√©
            signedSection.querySelector('#signedDocumentContainer').appendChild(documentElement);

            // Ins√©rer dans la page
            document.querySelector('.container').appendChild(signedSection);
        }

        async function downloadSignedPDF() {
            try {
                console.log('D√©but du t√©l√©chargement PDF...');
                
                // V√©rifier que les biblioth√®ques sont charg√©es
                if (!window.jspdf || !window.html2canvas) {
                    alert('‚ùå Biblioth√®ques PDF non charg√©es. Veuillez actualiser la page et r√©essayer.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const element = document.querySelector('#signedDocumentContainer .document-container');
                
                if (!element) {
                    console.error('√âl√©ment du document non trouv√©');
                    alert('‚ùå Document non trouv√©. Veuillez r√©essayer.');
                    return;
                }

                console.log('Element trouv√©:', element);
                
                // G√©n√©rer l'image avec html2canvas
                console.log('G√©n√©ration de l\'image...');
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: true,
                    backgroundColor: '#ffffff',
                    allowTaint: true,
                    foreignObjectRendering: true
                });
                
                console.log('Image g√©n√©r√©e:', canvas);
                
                // Cr√©er le PDF
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                console.log('Cr√©ation du PDF...');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Ajouter l'image
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // Nom du fichier
                const fileName = `certificat_naissance_signe_${new Date().toISOString().slice(0, 10)}.pdf`;
                
                console.log('T√©l√©chargement du fichier:', fileName);
                
                // T√©l√©charger
                pdf.save(fileName);
                
                console.log('PDF t√©l√©charg√© avec succ√®s');
                alert('‚úÖ PDF t√©l√©charg√© avec succ√®s !');

            } catch (error) {
                console.error('Erreur compl√®te lors de l\'export PDF:', error);
                console.error('Stack trace:', error.stack);
                alert(`‚ùå Erreur lors de la g√©n√©ration du PDF: ${error.message}`);
            }
        }

        function printDocument() {
            // Alternative d'impression si le PDF ne fonctionne pas
            const element = document.querySelector('#signedDocumentContainer .document-container');
            if (!element) {
                alert('‚ùå Document non trouv√©');
                return;
            }

            // Cr√©er une nouvelle fen√™tre pour l'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificat de Naissance Sign√©</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .document-container { max-width: 800px; margin: 0 auto; }
                        .info-section { margin-bottom: 20px; }
                        .signature-area { display: flex; justify-content: space-between; margin-top: 50px; }
                        .signature-box { flex: 1; margin: 0 10px; }
                        .signature-label { font-weight: bold; margin-bottom: 10px; }
                        @media print { 
                            body { margin: 0; } 
                            .document-container { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    ${element.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Attendre un peu puis imprimer
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }
    </script>
</body>
</html>
