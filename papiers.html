<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents Médicaux - AideSAMS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="js/document-manager.js"></script>
    <style>
        .document-container {
            background: white;
            margin: 20px auto;
            padding: 40px;
            max-width: 800px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            font-family: Arial, sans-serif;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #8B0000, #DC143C);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .hospital-info {
            text-align: center;
            color: #DC143C;
            font-weight: bold;
        }

        .document-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0;
            text-decoration: underline;
        }

        .form-section {
            margin: 20px 0;
            border: 1px solid #333;
        }

        .section-header {
            background-color: #a8c5e8;
            color: black;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            margin: 0;
        }

        .section-header.green {
            background-color: #90c695;
        }

        .form-row {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        .form-field {
            flex: 1;
            margin-right: 20px;
        }

        .form-field:last-child {
            margin-right: 0;
        }

        .form-field label {
            font-weight: bold;
            margin-right: 10px;
        }

        .form-field input, .form-field select, .form-field textarea {
            border: none;
            border-bottom: 1px dotted #333;
            background: transparent;
            font-family: inherit;
            padding: 2px 5px;
            width: 200px;
        }

        .signature-area {
            display: flex;
            margin-top: 30px;
            height: 150px;
        }

        .signature-box {
            flex: 1;
            border: 1px solid #333;
            margin: 0 10px;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        .signature-label {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .signature-canvas {
            width: 100%;
            height: 100px;
            border: 1px dashed #ccc;
            cursor: crosshair;
        }

        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .document-selector {
            margin-bottom: 20px;
        }

        .document-selector select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
        }

        .hidden {
            display: none;
        }

        .share-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
        }

        .share-link {
            word-break: break-all;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .share-link button:hover {
            background: linear-gradient(135deg, #0056b3, #003d82) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .copy-success {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media print {
            .controls, .overlay, .share-panel {
                display: none !important;
            }
            
            .document-container {
                box-shadow: none;
                margin: 0;
                padding: 20px;
                border-radius: 0;
            }
        }

        /* Animations et notifications */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .notification {
            animation: slideIn 0.3s ease-out;
        }

        .notification-content {
            position: relative;
        }

        /* Indicateurs de sécurité */
        .security-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1000;
        }

        .security-indicator.secure {
            background: rgba(34, 139, 34, 0.9);
        }

        .security-indicator.warning {
            background: rgba(255, 165, 0, 0.9);
        }

        .security-indicator.error {
            background: rgba(220, 20, 60, 0.9);
        }

        /* Validation des champs */
        .form-field input.invalid, .form-field select.invalid {
            border-bottom-color: #e74c3c !important;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .form-field input.valid, .form-field select.valid {
            border-bottom-color: #27ae60 !important;
            background-color: rgba(39, 174, 96, 0.1);
        }

        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .validation-message.error {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .validation-message.success {
            color: #27ae60;
            background-color: rgba(39, 174, 96, 0.1);
        }

        /* Signature canvas enhancements */
        .signature-canvas.has-signature {
            border-color: #27ae60;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.3);
        }

        /* Loading states */
        .btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }        /* Styles spécifiques pour chaque type de document */
        .table-section {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .table-section th, .table-section td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }

        .table-section th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        .checkbox-field {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
        }

        .checkbox-field input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .date-location {
            text-align: right;
            margin: 20px 0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav>
            <a href="index.html" class="nav-tab">🏠 Accueil</a>
            <a href="professeur.html" class="nav-tab" id="professeurTab" style="display: none;">👨‍🎓 Professeur</a>
            <a href="ph.html" class="nav-tab" id="phTab" style="display: none;">🧬 PH</a>
            <a href="rapport.html" class="nav-tab">📋 Rapports</a>
            <a href="morgue.html" class="nav-tab">⚰️ Morgue</a>
            <a href="statistiques.html" class="nav-tab">📊 Statistiques</a>
            <a href="service.html" class="nav-tab">🏥 Services</a>
            <a href="hierarchie.html" class="nav-tab">👥 Hiérarchie</a>
            <a href="papiers.html" class="nav-tab active">📄 Documents</a>
            <a href="manuels.html" class="nav-tab">📚 Manuels</a>
            <a href="informations.html" class="nav-tab">ℹ️ Informations</a>
            <a href="refus_de_soin.html" class="nav-tab">❌ Refus de soin</a>
            <a href="impayes.html" class="nav-tab">💰 Impayés</a>
            <a href="lspd.html" class="nav-tab">🚔 LSPD</a>
            <a href="parametres.html" class="nav-tab">⚙️ Paramètres</a>
        </nav>

        <h1>📄 Documents Médicaux</h1>

        <!-- Contrôles -->
        <div class="controls">
            <div class="document-selector">
                <select id="documentType">
                    <option value="arret_travail">Avis d'arrêt de travail</option>
                    <option value="certificat_naissance">Certificat de naissance</option>
                    <option value="facture_hospitalisation">Facture d'hospitalisation</option>
                </select>
            </div>
            
            <button class="btn" onclick="clearForm()">📝 Nouveau document</button>
            <button class="btn secondary" onclick="showSharePanel()" style="display: none;">🔗 Partager aux parents</button>
            <button class="btn success" onclick="exportToPDF()">📥 Exporter PDF</button>
            <button class="btn" onclick="saveDocument()">💾 Sauvegarder</button>
            <button class="btn" onclick="loadDocuments()">📂 Charger documents</button>
            <button class="btn" onclick="viewSignedDocuments()">📋 Documents signés</button>
            <button class="btn" onclick="createBackup()">💿 Sauvegarde</button>
            <button class="btn" onclick="restoreBackup()">📁 Restaurer</button>
        </div>

        <!-- Document d'arrêt de travail -->
        <div id="arret_travail" class="document-container">
            <div class="document-header">
                <div>
                    <div style="font-weight: bold;">Hôpital Central</div>
                </div>
                <div class="logo-section">
                    <div class="logo">🏥</div>
                    <div class="hospital-info">
                        San Andreas Medical Services
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="text-decoration: underline; font-weight: bold;">Eclipse Medical Tower</div>
                </div>
            </div>

            <div class="document-title">Avis d'arrêt de travail</div>

            <div class="form-section">
                <h3 class="section-header">Le patient</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>NOM :</label>
                        <input type="text" id="patient_nom" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Prénom :</label>
                        <input type="text" id="patient_prenom" placeholder="................................">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>ID :</label>
                        <input type="text" id="patient_id" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Date de naissance :</label>
                        <input type="date" id="patient_naissance">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Âge :</label>
                        <input type="number" id="patient_age" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Travail :</label>
                        <input type="text" id="patient_travail" placeholder="................................">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field" style="flex: 2;">
                        <label>Adresse :</label>
                        <input type="text" id="patient_adresse" placeholder="..................................................................." style="width: 400px;">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-header">Le médecin</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>NOM :</label>
                        <input type="text" id="medecin_nom" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Prénom :</label>
                        <input type="text" id="medecin_prenom" placeholder="................................">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>ID :</label>
                        <input type="text" id="medecin_id" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Grade :</label>
                        <input type="text" id="medecin_grade" placeholder="................................">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Valable à partir du :</label>
                        <input type="date" id="arret_debut">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Jusqu'au :</label>
                        <input type="date" id="arret_fin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Travail possible :</label>
                        <select id="travail_possible">
                            <option value="Non">Non</option>
                            <option value="Oui">Oui</option>
                            <option value="Partiel">Partiel</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field" style="flex: 2;">
                        <label>Raison de l'arrêt :</label>
                        <input type="text" id="raison_arret" placeholder="..................................................................." style="width: 400px;">
                    </div>
                </div>
            </div>

            <div class="signature-area">
                <div class="signature-box">
                    <div class="signature-label">Signature du médecin :</div>
                    <canvas class="signature-canvas" id="signature_medecin_arret"></canvas>
                </div>
                <div class="signature-box">
                    <div class="signature-label">Date et heure :</div>
                    <input type="datetime-local" id="date_signature_arret" style="width: 100%; margin-top: 20px;">
                </div>
            </div>
        </div>

        <!-- Certificat de naissance -->
        <div id="certificat_naissance" class="document-container hidden">
            <div class="document-header">
                <div>
                    <div style="font-weight: bold;">Hôpital Central</div>
                </div>
                <div class="logo-section">
                    <div class="logo">🏥</div>
                    <div class="hospital-info">
                        San Andreas Medical Services
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="text-decoration: underline; font-weight: bold;">Eclipse Medical Tower</div>
                </div>
            </div>

            <div class="document-title">Certificat de naissance</div>

            <div class="form-section">
                <h3 class="section-header green">L'enfant</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>NOM :</label>
                        <input type="text" id="enfant_nom" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Prénom :</label>
                        <input type="text" id="enfant_prenom" placeholder="................................">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>ID :</label>
                        <input type="text" id="enfant_id" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Date de naissance :</label>
                        <input type="date" id="enfant_naissance">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Sexe :</label>
                        <select id="enfant_sexe">
                            <option value="">Sélectionner...</option>
                            <option value="Masculin">Masculin</option>
                            <option value="Féminin">Féminin</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>Heure de naissance :</label>
                        <input type="time" id="enfant_heure">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Taille :</label>
                        <input type="text" id="enfant_taille" placeholder="............cm">
                    </div>
                    <div class="form-field">
                        <label>Poids :</label>
                        <input type="text" id="enfant_poids" placeholder="............g">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-header green">La mère</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>Prénom et NOM :</label>
                        <input type="text" id="mere_nom" placeholder="................................" style="width: 250px;">
                    </div>
                    <div class="form-field">
                        <label>Date de naissance :</label>
                        <input type="date" id="mere_naissance">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Âge :</label>
                        <input type="number" id="mere_age" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Nationalité :</label>
                        <input type="text" id="mere_nationalite" placeholder="................................">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-header green">Le père</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>Prénom et NOM :</label>
                        <input type="text" id="pere_nom" placeholder="................................" style="width: 250px;">
                    </div>
                    <div class="form-field">
                        <label>Date de naissance :</label>
                        <input type="date" id="pere_naissance">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Âge :</label>
                        <input type="number" id="pere_age" placeholder="................................">
                    </div>
                    <div class="form-field">
                        <label>Nationalité :</label>
                        <input type="text" id="pere_nationalite" placeholder="................................">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-header green">Le médecin</h3>
                <div class="form-row">
                    <div class="form-field">
                        <label>Prénom et NOM :</label>
                        <input type="text" id="medecin_nom_cert" placeholder="..................................................................." style="width: 350px;">
                    </div>
                    <div class="form-field">
                        <label>ID :</label>
                        <input type="text" id="medecin_id_cert" placeholder="................">
                    </div>
                </div>
            </div>

            <div class="signature-area">
                <div class="signature-box">
                    <div class="signature-label">Signature du médecin</div>
                    <canvas class="signature-canvas" id="signature_medecin_cert"></canvas>
                </div>
                <div class="signature-box">
                    <div class="signature-label">Signature des parents</div>
                    <canvas class="signature-canvas" id="signature_parents_cert"></canvas>
                </div>
            </div>
        </div>

        <!-- Facture d'hospitalisation -->
        <div id="facture_hospitalisation" class="document-container hidden">
            <div class="document-header">
                <div class="logo-section">
                    <div class="logo">🏥</div>
                    <div style="margin-left: 20px;">
                        <h2 style="margin: 0; color: #333;">San Andreas Medical Services</h2>
                        <p style="margin: 0; font-style: italic;">Notre Priorité, Votre Santé</p>
                    </div>
                </div>
                <div class="date-location">
                    Le <input type="text" id="facture_date" placeholder="XX/XX/20XX" style="border: none; border-bottom: 1px solid #333;">
                    <br>Los Santos
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; margin: 20px 0;">
                <div>
                    <strong>Los Santos Medical Services</strong><br>
                    Hôpital Eclipse Medical tower
                </div>
            </div>

            <div class="document-title">Facture de Frais d'Hospitalisation</div>

            <div style="margin: 20px 0;">
                <strong>Date de la facture :</strong> <input type="text" id="facture_date_emission" placeholder="[Date]" style="border: none; border-bottom: 1px dotted #333;"><br><br>
                <strong>Patient :</strong> <input type="text" id="facture_patient" placeholder="[Nom et prénom du patient]" style="border: none; border-bottom: 1px dotted #333; width: 300px;"><br><br>
                <strong>Médecin traitant :</strong> <input type="text" id="facture_medecin" placeholder="[Nom du médecin]" style="border: none; border-bottom: 1px dotted #333; width: 300px;">
            </div>

            <hr style="border: 1px solid #333; margin: 20px 0;">

            <h3>Détails des frais</h3>

            <table class="table-section">
                <thead>
                    <tr>
                        <th>Description des services</th>
                        <th>Quantité</th>
                        <th>Prix Unitaire ($)</th>
                        <th>Total ($)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><u>Soins</u></td>
                        <td><input type="text" id="soins_quantite" placeholder="[Nombre/ type de blessures]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="soins_prix" placeholder="[Prix par unité]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="soins_total" placeholder="[Total]" style="border: none; width: 100%;"></td>
                    </tr>
                    <tr>
                        <td><u>Médicaments</u></td>
                        <td><input type="text" id="medicaments_quantite" placeholder="[Liste des médicaments]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="medicaments_prix" placeholder="[Prix total]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="medicaments_total" placeholder="[Total]" style="border: none; width: 100%;"></td>
                    </tr>
                    <tr>
                        <td><u>Radiologie / Imagerie médicale</u></td>
                        <td><input type="text" id="radio_quantite" placeholder="[Description des examens]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="radio_prix" placeholder="[Prix]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="radio_total" placeholder="[Total]" style="border: none; width: 100%;"></td>
                    </tr>
                    <tr>
                        <td><u>Chirurgie (si applicable)</u></td>
                        <td><input type="text" id="chirurgie_quantite" placeholder="[Description de l'intervention]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="chirurgie_prix" placeholder="[Prix]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="chirurgie_total" placeholder="[Total]" style="border: none; width: 100%;"></td>
                    </tr>
                    <tr>
                        <td><u>Autres frais (précisez)</u></td>
                        <td><input type="text" id="autres_quantite" placeholder="[Description]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="autres_prix" placeholder="[Prix]" style="border: none; width: 100%;"></td>
                        <td><input type="text" id="autres_total" placeholder="[Total]" style="border: none; width: 100%;"></td>
                    </tr>
                </tbody>
            </table>

            <div style="text-align: right; margin: 20px 0; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                <strong>Total des frais d'hospitalisation :</strong> <input type="text" id="total_general" placeholder="[Total général] $" style="border: none; border-bottom: 2px solid #333; font-weight: bold; text-align: right;">
            </div>

            <div style="margin: 40px 0;">
                Fait à Los Santos le <input type="text" id="facture_date_signature" placeholder="XX/XX/20XX" style="border: none; border-bottom: 1px solid #333;">
                <div style="margin-top: 30px;">
                    <input type="text" id="facture_medecin_signature" placeholder="[Nom Prenom | ID]; [Grade];" style="border: none; border-bottom: 1px solid #333; width: 300px;">
                </div>
            </div>

            <div style="text-align: center; margin-top: 50px; font-size: 24px; font-style: italic;">
                Signature
            </div>

            <div class="signature-area" style="height: 100px;">
                <div class="signature-box" style="border: none; margin: 0;">
                    <canvas class="signature-canvas" id="signature_medecin_facture" style="height: 80px; border: 1px solid #ddd;"></canvas>
                </div>
            </div>
        </div>

        <!-- Panneau de partage -->
        <div id="sharePanel" class="share-panel hidden">
            <h3>Partager le certificat de naissance pour signature</h3>
            <p>Générez un lien sécurisé pour permettre aux parents de signer le certificat de naissance :</p>
            
            <div class="form-field">
                <label>Durée de validité :</label>
                <select id="linkExpiry" style="width: 100%; margin: 10px 0;">
                    <option value="24">24 heures</option>
                    <option value="48">48 heures</option>
                    <option value="72">72 heures</option>
                    <option value="168">1 semaine</option>
                </select>
            </div>
            
            <div class="share-link" id="generatedLink" style="display: none;">
                <strong>🔗 Lien généré avec succès !</strong><br><br>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px dashed #007bff; margin: 10px 0;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">URL de signature :</div>
                    <div id="linkUrl" style="font-family: monospace; font-size: 12px; word-break: break-all; color: #333; margin-bottom: 10px;"></div>
                    <button onclick="copyToClipboard()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; margin-bottom: 8px;">
                        📋 Copier le lien
                    </button>
                    <button onclick="testSignatureLink()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #28a745, #1e7e34); color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 12px;">
                        🧪 Tester le lien
                    </button>
                </div>
                <div style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">
                    💡 Envoyez ce lien au patient par SMS, email ou messagerie
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn success" onclick="generateShareLink()">🔗 Générer le lien</button>
                <button class="btn" onclick="closeSharePanel()">❌ Fermer</button>
            </div>
            
            <div id="linkInfo" style="display: none; margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 12px;">
                <strong>ℹ️ Informations du lien :</strong><br>
                • Le lien expire automatiquement après la durée sélectionnée<br>
                • Une fois le document signé, le lien devient inactif<br>
                • Vous recevrez une notification quand le document sera signé<br>
                • Le document signé sera accessible via "Documents signés"
            </div>
        </div>

        <div id="overlay" class="overlay hidden" onclick="closeSharePanel()"></div>

        <!-- Indicateur de sécurité -->
        <div class="security-indicator secure" id="securityIndicator">
            🔒 Documents sécurisés et chiffrés
        </div>
    </div>

    <script>
        // État global
        let currentDocument = 'arret_travail';
        let signatures = {};
        let isDrawing = false;
        let currentCanvas = null;
        let currentContext = null;
        let documentManager = null;
        let signatureManager = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les gestionnaires
            documentManager = new DocumentManager();
            signatureManager = new SignatureManager();
            
            updateSpecialityTabs();
            initializeSignatureCanvases();
            loadUserData();
            
            // Écouteur pour le changement de type de document
            document.getElementById('documentType').addEventListener('change', function() {
                switchDocument(this.value);
            });

            // Auto-calcul pour la facture
            setupFactureCalculations();
            
            // Charger les notifications de signatures
            checkSignatureNotifications();
            
            // Log de l'accès à la page
            AuditLogger.log('PAGE_ACCESS', { page: 'papiers.html' });
        });

        function updateSpecialityTabs() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const specialities = userData.specialities || [];
            
            console.log('Spécialités utilisateur:', specialities);
            
            // Afficher l'onglet Professeur si la spécialité contient "Professeur"
            const professeurTab = document.getElementById('professeurTab');
            if (professeurTab && specialities.some(spec => spec.toLowerCase().includes('professeur'))) {
                professeurTab.style.display = 'inline-block';
                console.log('Onglet Professeur affiché');
            }
            
            // Afficher l'onglet PH si la spécialité contient "PH"
            const phTab = document.getElementById('phTab');
            if (phTab && specialities.some(spec => spec.toLowerCase().includes('ph'))) {
                phTab.style.display = 'inline-block';
                console.log('Onglet PH affiché');
            }
        }

        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            // Pré-remplir les informations du médecin
            if (userData.nom) {
                document.getElementById('medecin_nom').value = userData.nom;
                document.getElementById('medecin_nom_cert').value = userData.prenom + ' ' + userData.nom;
                document.getElementById('facture_medecin').value = userData.prenom + ' ' + userData.nom;
                document.getElementById('facture_medecin_signature').value = userData.prenom + ' ' + userData.nom + ' | ' + (userData.id || '') + '; ' + (userData.grade || '') + ';';
            }
            if (userData.prenom) {
                document.getElementById('medecin_prenom').value = userData.prenom;
            }
            if (userData.id) {
                document.getElementById('medecin_id').value = userData.id;
                document.getElementById('medecin_id_cert').value = userData.id;
            }
            if (userData.grade) {
                document.getElementById('medecin_grade').value = userData.grade;
            }
        }

        function switchDocument(docType) {
            // Cacher tous les documents
            document.querySelectorAll('.document-container').forEach(doc => {
                doc.classList.add('hidden');
            });
            
            // Afficher le document sélectionné
            document.getElementById(docType).classList.remove('hidden');
            currentDocument = docType;
            
            // Afficher/Masquer le bouton de partage selon le type de document
            const shareButton = document.querySelector('button[onclick="showSharePanel()"]');
            if (shareButton) {
                if (docType === 'certificat_naissance') {
                    shareButton.style.display = 'inline-block';
                    shareButton.innerHTML = '🔗 Partager aux parents';
                } else {
                    shareButton.style.display = 'none';
                }
            }
            
            // Réinitialiser les canvas de signature
            setTimeout(initializeSignatureCanvases, 100);
        }

        function initializeSignatureCanvases() {
            document.querySelectorAll('.signature-canvas').forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                // Événements de dessin
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                // Événements tactiles
                canvas.addEventListener('touchstart', handleTouchStart);
                canvas.addEventListener('touchmove', handleTouchMove);
                canvas.addEventListener('touchend', stopDrawing);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            currentCanvas = e.target;
            currentContext = currentCanvas.getContext('2d');
            
            const rect = currentCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentContext.beginPath();
            currentContext.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing || !currentCanvas) return;
            
            const rect = currentCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentContext.lineTo(x, y);
            currentContext.stroke();
        }

        function stopDrawing() {
            if (isDrawing && currentCanvas) {
                signatures[currentCanvas.id] = currentCanvas.toDataURL();
                // Ajouter une classe CSS pour indiquer qu'il y a une signature
                currentCanvas.classList.add('has-signature');
                
                // Log de l'action de signature
                AuditLogger.log('SIGNATURE_CREATED', { 
                    canvasId: currentCanvas.id,
                    documentType: currentDocument
                });
            }
            isDrawing = false;
            currentCanvas = null;
            currentContext = null;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            e.target.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            e.target.dispatchEvent(mouseEvent);
        }

        function clearForm() {
            // Vider tous les champs
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type === 'checkbox' || field.type === 'radio') {
                    field.checked = false;
                } else {
                    field.value = '';
                }
            });
            
            // Effacer les signatures
            document.querySelectorAll('.signature-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.classList.remove('has-signature');
            });
            
            signatures = {};
            
            // Recharger les données utilisateur
            loadUserData();
            
            // Définir la date/heure actuelle
            const now = new Date();
            const dateTimeString = now.toISOString().slice(0, 16);
            const dateString = now.toISOString().slice(0, 10);
            
            document.getElementById('date_signature_arret').value = dateTimeString;
            document.getElementById('facture_date').value = now.toLocaleDateString('fr-FR');
            document.getElementById('facture_date_emission').value = now.toLocaleDateString('fr-FR');
            document.getElementById('facture_date_signature').value = now.toLocaleDateString('fr-FR');
        }

        function setupFactureCalculations() {
            // Auto-calcul des totaux dans la facture
            const calculFields = [
                { qty: 'soins_quantite', price: 'soins_prix', total: 'soins_total' },
                { qty: 'medicaments_quantite', price: 'medicaments_prix', total: 'medicaments_total' },
                { qty: 'radio_quantite', price: 'radio_prix', total: 'radio_total' },
                { qty: 'chirurgie_quantite', price: 'chirurgie_prix', total: 'chirurgie_total' },
                { qty: 'autres_quantite', price: 'autres_prix', total: 'autres_total' }
            ];

            calculFields.forEach(field => {
                const priceField = document.getElementById(field.price);
                if (priceField) {
                    priceField.addEventListener('input', calculateFactureTotal);
                }
            });
        }

        function calculateFactureTotal() {
            const totals = [
                'soins_total', 'medicaments_total', 'radio_total', 
                'chirurgie_total', 'autres_total'
            ];
            
            let grandTotal = 0;
            totals.forEach(totalId => {
                const field = document.getElementById(totalId);
                if (field && field.value) {
                    const value = parseFloat(field.value.replace(/[^0-9.-]/g, ''));
                    if (!isNaN(value)) {
                        grandTotal += value;
                    }
                }
            });
            
            const totalField = document.getElementById('total_general');
            if (totalField) {
                totalField.value = grandTotal.toFixed(2) + ' $';
            }
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            
            // Cacher les contrôles
            document.querySelector('.controls').style.display = 'none';
            
            try {
                const element = document.getElementById(currentDocument);
                
                // Générer l'image avec html2canvas
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                
                // Créer le PDF
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                let position = 0;
                
                // Ajouter la première page
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Ajouter des pages supplémentaires si nécessaire
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Nom du fichier
                const fileName = `${currentDocument}_${new Date().toISOString().slice(0, 10)}.pdf`;
                
                // Télécharger
                pdf.save(fileName);
                
            } catch (error) {
                console.error('Erreur lors de l\'export PDF:', error);
                alert('Erreur lors de la génération du PDF');
            } finally {
                // Réafficher les contrôles
                document.querySelector('.controls').style.display = 'block';
            }
        }

        function saveDocument() {
            const documentData = {
                type: currentDocument,
                timestamp: new Date().toISOString(),
                data: {},
                signatures: signatures
            };
            
            // Collecter tous les champs du document actuel
            document.getElementById(currentDocument).querySelectorAll('input, select, textarea').forEach(field => {
                // Nettoyer les entrées pour la sécurité
                documentData.data[field.id] = FormValidator.sanitizeInput(field.value);
            });
            
            // Valider le document
            const validationErrors = FormValidator.validateDocumentData(documentData.data, currentDocument);
            if (validationErrors.length > 0) {
                alert('Erreurs de validation:\n' + validationErrors.join('\n'));
                return;
            }
            
            // Sauvegarder de manière sécurisée
            const docId = documentManager.saveSecureDocument(documentData);
            
            // Log de la sauvegarde
            AuditLogger.log('DOCUMENT_SAVED', { 
                documentId: docId, 
                type: currentDocument,
                fieldsCount: Object.keys(documentData.data).length
            });
            
            alert('Document sauvegardé avec succès de manière sécurisée !');
        }

        function loadDocuments() {
            const savedDocuments = JSON.parse(localStorage.getItem('savedDocuments') || '[]');
            
            if (savedDocuments.length === 0) {
                alert('Aucun document sauvegardé trouvé.');
                return;
            }
            
            // Créer une liste des documents
            let docList = 'Documents sauvegardés:\n\n';
            savedDocuments.forEach((doc, index) => {
                const date = new Date(doc.timestamp).toLocaleString('fr-FR');
                docList += `${index + 1}. ${doc.type} - ${date}\n`;
            });
            
            const selection = prompt(docList + '\nEntrez le numéro du document à charger:');
            const docIndex = parseInt(selection) - 1;
            
            if (docIndex >= 0 && docIndex < savedDocuments.length) {
                const doc = savedDocuments[docIndex];
                
                // Changer le type de document
                document.getElementById('documentType').value = doc.type;
                switchDocument(doc.type);
                
                // Charger les données
                setTimeout(() => {
                    Object.keys(doc.data).forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = doc.data[fieldId];
                        }
                    });
                    
                    // Charger les signatures
                    Object.keys(doc.signatures).forEach(canvasId => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            img.onload = function() {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(img, 0, 0);
                            };
                            img.src = doc.signatures[canvasId];
                        }
                    });
                    
                    signatures = { ...doc.signatures };
                }, 200);
                
                alert('Document chargé avec succès !');
            }
        }

        function showSharePanel() {
            // Vérifier que seul le certificat de naissance peut être partagé
            if (currentDocument !== 'certificat_naissance') {
                alert('Seul le certificat de naissance peut être partagé pour signature par les parents.');
                return;
            }
            
            document.getElementById('sharePanel').classList.remove('hidden');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function closeSharePanel() {
            document.getElementById('sharePanel').classList.add('hidden');
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('generatedLink').style.display = 'none';
        }

        function generateShareLink() {
            // Vérifier que seul le certificat de naissance peut être partagé
            if (currentDocument !== 'certificat_naissance') {
                alert('Seul le certificat de naissance peut être partagé pour signature par les parents.');
                return;
            }
            
            const expiry = document.getElementById('linkExpiry').value;
            
            // Générer un ID unique pour le lien
            const linkId = documentManager.generateDocumentId();
            
            // Collecter les données actuelles
            const documentData = {};
            document.getElementById(currentDocument).querySelectorAll('input, select, textarea').forEach(field => {
                documentData[field.id] = FormValidator.sanitizeInput(field.value);
            });
            
            // Valider le document avant partage
            const validationErrors = FormValidator.validateDocumentData(documentData, currentDocument);
            if (validationErrors.length > 0) {
                alert('Le certificat de naissance doit être complètement rempli avant partage:\n' + validationErrors.join('\n'));
                return;
            }
            
            // Sauvegarder le document pour partage
            const shareData = {
                id: linkId,
                type: currentDocument,
                patientEmail: 'Parents (Certificat de naissance)',
                doctorId: documentManager.getCurrentDoctorId(),
                expiresAt: new Date(Date.now() + expiry * 60 * 60 * 1000).toISOString(),
                data: documentData,
                signatures: { ...signatures },
                signed: false,
                patientSignature: null,
                createdAt: new Date().toISOString()
            };
            
            // Sauvegarder
            const sharedDocuments = JSON.parse(localStorage.getItem('sharedDocuments') || '[]');
            sharedDocuments.push(shareData);
            localStorage.setItem('sharedDocuments', JSON.stringify(sharedDocuments));
            
            // Générer l'URL
            const baseUrl = window.location.origin + window.location.pathname.replace('papiers.html', '');
            const shareUrl = `${baseUrl}signature.html?id=${linkId}`;
            
            document.getElementById('linkUrl').textContent = shareUrl;
            document.getElementById('generatedLink').style.display = 'block';
            document.getElementById('linkInfo').style.display = 'block';
            
            // Log de l'action
            AuditLogger.log('SHARE_LINK_GENERATED', { 
                documentId: linkId,
                patientEmail: 'Parents (Certificat de naissance)',
                expiryHours: expiry,
                documentType: currentDocument
            });
            
            // Afficher le lien généré
            alert(`Lien sécurisé généré avec succès !\n\nDocument: Certificat de naissance\nExpiration: ${expiry} heures\n\nUtilisez le bouton "Copier" pour copier le lien et l'envoyer aux parents.`);
        }

        function copyToClipboard() {
            const link = document.getElementById('linkUrl').textContent;
            
            // Copier dans le presse-papiers
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyTextToClipboard(link);
                });
            } else {
                fallbackCopyTextToClipboard(link);
            }
        }

        function showCopySuccess() {
            const button = document.querySelector('#generatedLink button');
            const originalText = button.textContent;
            
            button.textContent = '✅ Copié !';
            button.style.background = '#27ae60';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
            
            // Afficher une notification
            alert('✅ Lien copié dans le presse-papiers !\n\nVous pouvez maintenant l\'envoyer au patient par SMS, email ou messagerie.');
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    alert('❌ Erreur lors de la copie. Veuillez copier manuellement le lien affiché.');
                }
            } catch (err) {
                alert('❌ Erreur lors de la copie. Veuillez copier manuellement le lien affiché.');
            }
            
            document.body.removeChild(textArea);
        }

        function testSignatureLink() {
            const link = document.getElementById('linkUrl').textContent;
            if (link) {
                window.open(link, '_blank');
                
                // Log de l'action de test
                AuditLogger.log('SIGNATURE_LINK_TESTED', { 
                    link: link,
                    timestamp: new Date().toISOString()
                });
            } else {
                alert('❌ Aucun lien généré à tester.');
            }
        }

        // Fonctions utilitaires supplémentaires
        function checkSignatureNotifications() {
            if (!signatureManager) return;
            
            const newSignatures = signatureManager.checkForNewSignatures();
            if (newSignatures.length > 0) {
                showSignatureAlert(newSignatures);
            }
            
            // Afficher les statistiques
            updateSignatureStats();
        }

        function showSignatureAlert(signatures) {
            const count = signatures.length;
            const message = count === 1 
                ? `Vous avez 1 nouveau document signé !`
                : `Vous avez ${count} nouveaux documents signés !`;
            
            if (confirm(message + '\nVoulez-vous voir les détails ?')) {
                showSignatureDetails(signatures);
            }
        }

        function showSignatureDetails(signatures) {
            let details = 'Documents signés:\n\n';
            signatures.forEach((doc, index) => {
                const date = new Date(doc.signedAt).toLocaleString('fr-FR');
                details += `${index + 1}. ${doc.type} - ${doc.patientEmail} - ${date}\n`;
            });
            
            alert(details);
            
            // Marquer comme notifiées
            signatures.forEach(doc => {
                signatureManager.markSignatureAsNotified(doc.id);
            });
        }

        function updateSignatureStats() {
            if (!signatureManager) return;
            
            const stats = signatureManager.getSignatureStats();
            console.log('Statistiques de signatures:', stats);
            
            // Mettre à jour l'interface si nécessaire
            // (Peut être étendu pour afficher dans l'UI)
        }

        function viewSignedDocuments() {
            const sharedDocuments = JSON.parse(localStorage.getItem('sharedDocuments') || '[]');
            const doctorId = documentManager.getCurrentDoctorId();
            
            const mySignedDocs = sharedDocuments.filter(doc => 
                doc.doctorId === doctorId && doc.signed
            );
            
            if (mySignedDocs.length === 0) {
                alert('Aucun document signé trouvé.');
                return;
            }
            
            // Créer une fenêtre popup moderne
            createSignedDocumentsWindow(mySignedDocs);
        }

        function createSignedDocumentsWindow(documents) {
            const popup = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
            
            const html = generateSignedDocumentsPage(documents);
            popup.document.write(html);
            popup.document.close();
        }

        function generateSignedDocumentsPage(documents) {
            let html = '<!DOCTYPE html>';
            html += '<html lang="fr">';
            html += '<head>';
            html += '<meta charset="UTF-8">';
            html += '<title>Documents Signés - AideSAMS</title>';
            html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
            html += '<style>';
            html += 'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }';
            html += '.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }';
            html += '.document-card { background: white; margin: 15px 0; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #28a745; }';
            html += '.doc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }';
            html += '.doc-title { font-size: 18px; font-weight: bold; color: #333; }';
            html += '.doc-date { color: #666; font-size: 14px; }';
            html += '.doc-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }';
            html += '.info-item { padding: 8px 12px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #007bff; }';
            html += '.info-label { font-weight: bold; color: #495057; font-size: 12px; text-transform: uppercase; }';
            html += '.info-value { color: #333; margin-top: 2px; }';
            html += '.signature-container { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px dashed #28a745; text-align: center; }';
            html += '.signature-image { max-width: 300px; height: auto; border: 2px solid #ddd; border-radius: 5px; background: white; }';
            html += '.action-buttons { display: flex; gap: 10px; margin-top: 15px; }';
            html += '.btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; }';
            html += '.btn-primary { background: #007bff; color: white; }';
            html += '.btn-success { background: #28a745; color: white; }';
            html += '.btn-info { background: #17a2b8; color: white; }';
            html += '.btn:hover { opacity: 0.8; transform: translateY(-1px); }';
            html += '.stats { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }';
            html += '.empty-state { text-align: center; padding: 40px; color: #666; }';
            html += '</style>';
            html += '</head>';
            html += '<body>';
            
            html += '<div class="header">';
            html += '<h1>📋 Documents Signés</h1>';
            html += '<p>Gestion des documents médicaux signés par les patients</p>';
            html += '</div>';
            
            html += '<div class="stats">';
            html += '<strong>' + documents.length + '</strong> document(s) signé(s) au total';
            html += '</div>';
            
            documents.forEach((doc, index) => {
                const signedDate = new Date(doc.signedAt).toLocaleString('fr-FR');
                const createdDate = new Date(doc.createdAt || doc.timestamp || Date.now()).toLocaleString('fr-FR');
                
                html += '<div class="document-card">';
                html += '<div class="doc-header">';
                html += '<div class="doc-title">#' + (index + 1) + ' - ' + getDocumentTypeDisplayName(doc.type) + '</div>';
                html += '<div class="doc-date">Signé le ' + signedDate + '</div>';
                html += '</div>';
                
                html += '<div class="doc-info">';
                html += '<div class="info-item">';
                html += '<div class="info-label">Patient</div>';
                html += '<div class="info-value">' + doc.patientEmail + '</div>';
                html += '</div>';
                html += '<div class="info-item">';
                html += '<div class="info-label">Créé le</div>';
                html += '<div class="info-value">' + createdDate + '</div>';
                html += '</div>';
                html += '<div class="info-item">';
                html += '<div class="info-label">Statut</div>';
                html += '<div class="info-value">✅ Signé et validé</div>';
                html += '</div>';
                html += '<div class="info-item">';
                html += '<div class="info-label">ID Document</div>';
                html += '<div class="info-value">' + doc.id + '</div>';
                html += '</div>';
                html += '</div>';
                
                html += '<div class="signature-container">';
                html += '<div style="margin-bottom: 10px;"><strong>🖋️ Signature du patient :</strong></div>';
                if (doc.patientSignature) {
                    html += '<img src="' + doc.patientSignature + '" alt="Signature patient" class="signature-image">';
                } else {
                    html += '<div style="color: #999; font-style: italic;">Aucune signature trouvée</div>';
                }
                html += '</div>';
                
                html += '<div class="action-buttons">';
                html += '<button class="btn btn-primary" onclick="viewDocumentDetails(\'' + doc.id + '\')">👁️ Voir détails</button>';
                html += '<button class="btn btn-success" onclick="downloadPDF(\'' + doc.id + '\')">📥 Télécharger PDF</button>';
                html += '<button class="btn btn-info" onclick="copySignature(\'' + doc.id + '\')">📋 Copier signature</button>';
                html += '</div>';
                
                html += '</div>';
            });
            
            html += '<script>';
            html += 'function viewDocumentDetails(docId) {';
            html += 'const docs = ' + JSON.stringify(documents) + ';';
            html += 'const doc = docs.find(d => d.id === docId);';
            html += 'if (doc) {';
            html += 'let details = "📄 Détails du document:\\n\\n";';
            html += 'details += "Type: " + doc.type + "\\n";';
            html += 'details += "Patient: " + doc.patientEmail + "\\n";';
            html += 'details += "Signé le: " + new Date(doc.signedAt).toLocaleString("fr-FR") + "\\n";';
            html += 'details += "ID: " + doc.id + "\\n\\n";';
            html += 'if (doc.data) {';
            html += 'details += "Données du document:\\n";';
            html += 'Object.keys(doc.data).forEach(key => {';
            html += 'if (doc.data[key]) details += key + ": " + doc.data[key] + "\\n";';
            html += '});';
            html += '}';
            html += 'alert(details);';
            html += '}';
            html += '}';
            
            html += 'function downloadPDF(docId) {';
            html += 'alert("🚧 Fonctionnalité de téléchargement PDF en cours de développement pour le document " + docId + "\\n\\nEn attendant, vous pouvez utiliser Ctrl+P pour imprimer cette page.");';
            html += '}';
            
            html += 'function copySignature(docId) {';
            html += 'const docs = ' + JSON.stringify(documents) + ';';
            html += 'const doc = docs.find(d => d.id === docId);';
            html += 'if (doc && doc.patientSignature) {';
            html += 'navigator.clipboard.writeText(doc.patientSignature).then(() => {';
            html += 'alert("✅ Signature copiée dans le presse-papiers !");';
            html += '}).catch(() => {';
            html += 'alert("❌ Erreur lors de la copie de la signature.");';
            html += '});';
            html += '} else {';
            html += 'alert("❌ Aucune signature trouvée pour ce document.");';
            html += '}';
            html += '}';
            
            html += 'document.addEventListener("keydown", function(e) {';
            html += 'if (e.key === "Escape") window.close();';
            html += '});';
            html += '<\/script>';
            
            html += '</body>';
            html += '</html>';
            
            return html;
        }

        function getDocumentTypeDisplayName(type) {
            const types = {
                'arret_travail': 'Avis d\'arrêt de travail',
                'certificat_naissance': 'Certificat de naissance',
                'facture_hospitalisation': 'Facture d\'hospitalisation'
            };
            return types[type] || type;
        }

        function createBackup() {
            try {
                BackupManager.createBackup();
                alert('Sauvegarde créée avec succès !');
            } catch (error) {
                alert('Erreur lors de la création de la sauvegarde: ' + error.message);
            }
        }

        function restoreBackup() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    BackupManager.restoreBackup(file)
                        .then(backup => {
                            alert(`Sauvegarde restaurée avec succès !\nDate: ${new Date(backup.timestamp).toLocaleString('fr-FR')}`);
                            location.reload();
                        })
                        .catch(error => {
                            alert('Erreur lors de la restauration: ' + error.message);
                        });
                }
            };
            
            fileInput.click();
        }

        // Initialisation au chargement
        clearForm();
    </script>
</body>
</html>